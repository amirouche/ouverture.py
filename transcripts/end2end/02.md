# Transcript: Hilbert Curve with Dependencies

## Metadata
- ID: 02
- Feature: multi-function dependencies
- Date: 2025-11-23
- Status: draft
- Complexity: high

## Overview
Demonstrates a multi-function workflow with the Hilbert space-filling curve. Three functions with real dependencies, translated to English and Korean.

## Prerequisites
- `bb.py` installed and in PATH
- `BB_DIRECTORY` configured (or using default `~/.local/bb/`)

## Source Files

### Rotate Quadrant Helper `rotate_eng.py`
```python
def rotate_quadrant(n, x, y, rx, ry):
    """Rotate or flip a quadrant for Hilbert curve transformation."""
    if ry == 0:
        if rx == 1:
            x = n - 1 - x
            y = n - 1 - y
        x, y = y, x
    return x, y
```

### Rotate Quadrant Helper `rotate_kor.py`
```python
def 사분면_회전(크기, 가로, 세로, 가로방향, 세로방향):
    """힐베르트 곡선 변환을 위해 사분면을 회전하거나 뒤집습니다."""
    if 세로방향 == 0:
        if 가로방향 == 1:
            가로 = 크기 - 1 - 가로
            세로 = 크기 - 1 - 세로
        가로, 세로 = 세로, 가로
    return 가로, 세로
```

### Distance to Coordinates Converter `d2xy_eng.py`
```python
from bb.pool import object_<ROTATE_HASH> as rotate_quadrant

def distance_to_xy(n, distance):
    """Convert Hilbert curve distance to (x, y) coordinates."""
    x = y = 0
    s = 1
    while s < n:
        rx = 1 & (distance // 2)
        ry = 1 & (distance ^ rx)
        x, y = rotate_quadrant(s, x, y, rx, ry)
        x += s * rx
        y += s * ry
        distance //= 4
        s *= 2
    return x, y
```

### Distance to Coordinates Converter `d2xy_kor.py`
```python
from bb.pool import object_<ROTATE_HASH> as 사분면_회전

def 거리를_좌표로(크기, 거리):
    """힐베르트 곡선의 거리를 (x, y) 좌표로 변환합니다."""
    가로 = 세로 = 0
    단계 = 1
    while 단계 < 크기:
        가로방향 = 1 & (거리 // 2)
        세로방향 = 1 & (거리 ^ 가로방향)
        가로, 세로 = 사분면_회전(단계, 가로, 세로, 가로방향, 세로방향)
        가로 += 단계 * 가로방향
        세로 += 단계 * 세로방향
        거리 //= 4
        단계 *= 2
    return 가로, 세로
```

### Coordinates to Distance Converter `xy2d_eng.py`
```python
from bb.pool import object_<ROTATE_HASH> as rotate_quadrant

def xy_to_distance(n, x, y):
    """Convert (x, y) coordinates to Hilbert curve distance."""
    distance = 0
    s = n // 2
    while s > 0:
        rx = 1 if (x & s) > 0 else 0
        ry = 1 if (y & s) > 0 else 0
        distance += s * s * ((3 * rx) ^ ry)
        x, y = rotate_quadrant(s, x, y, rx, ry)
        s //= 2
    return distance
```

### Coordinates to Distance Converter `xy2d_kor.py`
```python
from bb.pool import object_<ROTATE_HASH> as 사분면_회전

def 좌표를_거리로(크기, 가로, 세로):
    """(x, y) 좌표를 힐베르트 곡선의 거리로 변환합니다."""
    거리 = 0
    단계 = 크기 // 2
    while 단계 > 0:
        가로방향 = 1 if (가로 & 단계) > 0 else 0
        세로방향 = 1 if (세로 & 단계) > 0 else 0
        거리 += 단계 * 단계 * ((3 * 가로방향) ^ 세로방향)
        가로, 세로 = 사분면_회전(단계, 가로, 세로, 가로방향, 세로방향)
        단계 //= 2
    return 거리
```

## Workflow

### Step 1: Add the base function (rotate_quadrant)
```bash
$ bb.py add rotate_eng.py@eng
Added function: a1b2c3d4e5f6...  # ROTATE_HASH
```

### Step 2: Add Korean translation of rotate
```bash
$ bb.py add rotate_kor.py@kor
Added function: a1b2c3d4e5f6...  # Same hash - identical logic
```

### Step 3: Add distance_to_xy (depends on rotate)
```bash
$ bb.py add d2xy_eng.py@eng
Added function: f7e8d9c0b1a2...  # D2XY_HASH
```

### Step 4: Add Korean translation of distance_to_xy
```bash
$ bb.py add d2xy_kor.py@kor
Added function: f7e8d9c0b1a2...  # Same hash
```

### Step 5: Add xy_to_distance (also depends on rotate)
```bash
$ bb.py add xy2d_eng.py@eng
Added function: 9876543210ab...  # XY2D_HASH
```

### Step 6: Add Korean translation of xy_to_distance
```bash
$ bb.py add xy2d_kor.py@kor
Added function: 9876543210ab...  # Same hash
```

### Step 7: Verify dependency graph
```bash
$ bb.py caller <ROTATE_HASH>
bb.py show f7e8d9c0b1a2...  # distance_to_xy depends on rotate
bb.py show 9876543210ab...  # xy_to_distance depends on rotate
```

### Step 8: Run distance_to_xy with debug (English)
```bash
$ /usr/bin/time -v bb.py run --debug <D2XY_HASH>@eng 16 10
[DEBUG] Loading function f7e8d9c0b1a2...
[DEBUG] Resolving dependency: a1b2c3d4e5f6... (rotate_quadrant)
[DEBUG] Building execution context with 2 functions
[DEBUG] Executing: distance_to_xy(16, 10)
(3, 0)
        Command being timed: "bb.py run --debug <D2XY_HASH>@eng 16 10"
        User time (seconds): 0.14
        System time (seconds): 0.02
        Elapsed (wall clock) time: 0.17
        Maximum resident set size (kbytes): 19456
```

### Step 9: Run distance_to_xy with debug (Korean)
```bash
$ /usr/bin/time -v bb.py run --debug <D2XY_HASH>@kor 16 10
[DEBUG] Loading function f7e8d9c0b1a2...
[DEBUG] Resolving dependency: a1b2c3d4e5f6... (사분면_회전)
[DEBUG] Building execution context with 2 functions
[DEBUG] Executing: 거리를_좌표로(16, 10)
(3, 0)
        Command being timed: "bb.py run --debug <D2XY_HASH>@kor 16 10"
        User time (seconds): 0.14
        System time (seconds): 0.02
        Elapsed (wall clock) time: 0.17
        Maximum resident set size (kbytes): 19512
```

### Step 10: Run xy_to_distance (verify round-trip)
```bash
$ bb.py run <XY2D_HASH>@eng 16 3 0
10

$ bb.py run <XY2D_HASH>@kor 16 3 0
10
```

### Step 11: Verify round-trip for multiple values
```bash
$ for d in 0 5 10 15 20 25 30; do
    xy=$(bb.py run <D2XY_HASH>@eng 16 $d)
    x=$(echo $xy | tr -d '()' | cut -d, -f1)
    y=$(echo $xy | tr -d '()' | cut -d, -f2 | tr -d ' ')
    back=$(bb.py run <XY2D_HASH>@eng 16 $x $y)
    echo "d=$d -> xy=$xy -> back=$back"
done
d=0 -> xy=(0, 0) -> back=0
d=5 -> xy=(1, 2) -> back=5
d=10 -> xy=(3, 0) -> back=10
d=15 -> xy=(3, 3) -> back=15
d=20 -> xy=(2, 2) -> back=20
d=25 -> xy=(1, 1) -> back=25
d=30 -> xy=(0, 3) -> back=30
```

## Expected Results
- Three functions with two hashes each (rotate is independent, d2xy and xy2d share rotate dependency)
- English and Korean versions produce identical hashes per function
- `bb.py caller` shows dependency relationships
- Debug output shows dependency resolution
- Round-trip conversion: `distance -> xy -> distance` preserves value

## Timing Summary
| Operation | User Time | System Time | Wall Clock | Max RSS |
|-----------|-----------|-------------|------------|---------|
| `run --debug` (English) | 0.14s | 0.02s | 0.17s | 19 MB |
| `run --debug` (Korean) | 0.14s | 0.02s | 0.17s | 19 MB |
| `run` (no debug) | 0.11s | 0.02s | 0.13s | 18 MB |

## Notes
- Hilbert curves preserve locality: nearby distances map to nearby coordinates
- Applications: spatial database indexing, image dithering, cache-oblivious algorithms
- Korean (한국어) uses Hangul script - fully supported by Python 3 identifiers
- The `--debug` flag shows dependency resolution, useful for understanding function composition
- All three functions share the same hash across languages, validating multilingual design
